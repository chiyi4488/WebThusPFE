---
layout: default
title: 管理租借
permalink: /manage/
---

<h3 style="font-weight: 700;">管理租借
    <hr>
</h3>
<div class="row justify-content-center">
    <div class="col-lg-12" id="rentTableCol">
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">租借日期</th>
                    <th scope="col">租借時段</th>
                    <th scope="col">項目</th>
                    <th scope="col">狀態</th>
                    <th scope="col">操作</th>
                </tr>
            </thead>
            <tbody id="rentInfoTableBody">
                <!-- 這裡會動態生成租借資訊 -->
            </tbody>
        </table>
    </div>

    <div class="col-lg-12" id="detailsCol" style="display: none;">
        <div class="row">
            <div class="col-2 mb-3 d-grid">
                <button type="button" class="btn btn-dark" id="backButton" data-mdb-ripple-init>
                    <span style="font-size:large;">
                        <i class="bi bi-arrow-left-circle"></i>
                    </span>
                </button>

            </div>
            <div class="col-10 mb-3" id="saveButtonContainer" style="display: none;">
                <div class="d-grid">
                    <button type="button" class="btn btn-primary btn-lg" id="saveButton" data-mdb-ripple-init>儲存</button>
                </div>
            </div>
            <div class="col-10 mb-3" id="editButtonContainer">
                <div class="d-grid">
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-warning btn-lg" id="editButton" data-mdb-ripple-init>編輯資訊</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="card" id="detailsCard">
                    <div class="card-body">
                        <h5 class="card-title">詳細資訊</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col">項目</th>
                                    <th scope="col">內容</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                                <tr>
                                    <td>姓名</td>
                                    <td id="detailsName">王大明</td>
                                </tr>
                                <tr>
                                    <td>教師／學生證號</td>
                                    <td id="detailsID">412401000</td>
                                </tr>
                                <tr>
                                    <td>聯絡電話</td>
                                    <td id="detailsPhone">0900000000</td>
                                </tr>
                                <tr>
                                    <td>狀態</td>
                                    <td id="detailsStatus"><span class="badge badge-primary"
                                            style="font-size: 14px;">預約成功</span></td>
                                </tr>
                                <tr>
                                    <td>租借日期</td>
                                    <td id="detailsDate">2024-05-25</td>
                                </tr>
                                <tr>
                                    <td>租借時間</td>
                                    <td id="detailsTime">09:00-10:00, 10:00-11:00</td>
                                </tr>
                                <tr>
                                    <td>租借項目</td>
                                    <td id="detailsItem">高階13色流式細胞儀</td>
                                </tr>
                                <tr>
                                    <td>租借事由</td>
                                    <td id="detailsReason">做實驗。</td>
                                </tr>

                            </tbody>
                        </table>


                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    $(document).ready(function () {
        const rentInfoKey = 'rentInfoList';
        let currentEditIndex = null;
        let isEditing = false;

        function loadRentInfo() {
            const rentInfoList = JSON.parse(localStorage.getItem(rentInfoKey)) || [];
            const tbody = $('#rentInfoTableBody');
            tbody.empty();
            rentInfoList.forEach((info, index) => {
                const statusBadge = getStatusBadge(info.status, info.date);
                const actionButton = getActionButton(info.status, index);
                const row = `
                    <tr data-index="${index}">
                        <td>${info.date}</td>
                        <td>${info.timeSlots.join(', ')}</td>
                        <td>${info.item}</td>
                        <td>${statusBadge}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function getActionButton(status, index) {
            const disabled = isEditing ? 'disabled' : '';
            return `<button type="button" class="btn btn-secondary btn-sm" onclick="viewDetails(${index})" data-mdb-ripple-init ${disabled}><i class="bi bi-eye-fill"></i></button>`;
        }

        function getStatusBadge(status, date) {
            let badgeClass = '';
            let badgeText = '';
            switch (status) {
                case '尚未繳費':
                    badgeClass = 'badge-warning';
                    badgeText = `<a class="link-warning" href="/payment.html?time=${date}">尚未繳費</a>`;
                    break;
                case '預約成功':
                    badgeClass = 'badge-primary';
                    badgeText = '預約成功';
                    break;
                case '繳費逾期':
                    badgeClass = 'badge-danger';
                    badgeText = '繳費逾期';
                    break;
                case '已經取消':
                    badgeClass = 'badge-secondary';
                    badgeText = '已經取消';
                    break;
            }
            return `<span class="badge ${badgeClass}" style="font-size: 14px;">${badgeText}</span>`;
        }

        window.viewDetails = function (index) {
            const rentInfoList = JSON.parse(localStorage.getItem(rentInfoKey)) || [];
            const info = rentInfoList[index];
            $('#detailsName').text(info.name || 'N/A');
            $('#detailsID').text(info.id || 'N/A');
            $('#detailsPhone').text(info.phone || 'N/A');
            $('#detailsDate').text(info.date);
            $('#detailsTime').text(info.timeSlots.join(', '));
            $('#detailsReason').text(info.reason || 'N/A');
            $('#detailsStatus').html(getStatusBadge(info.status, info.date));
            $('#detailsItem').text(info.item || 'N/A');
            currentEditIndex = index;

            $('#rentTableCol').hide();
            $('#detailsCol').fadeIn();

            $('#cancelReservationButton').off('click').on('click', function () {
                if (confirm('點選 [確定取消] 後，系統即會撤銷您的預約，並依照付款方式進行退費。如未付款，則逕行取消。確定要繼續執行嗎？')) {
                    rentInfoList[index].status = '已經取消';
                    localStorage.setItem(rentInfoKey, JSON.stringify(rentInfoList));
                    loadRentInfo();
                }
            });

            $('#editButton').off('click').on('click', function () {
                editDetails(info);
            });

            $('#backButton').off('click').on('click', function () {
                if (!isEditing) {
                    $('#detailsCol').fadeOut(function () {
                        $('#rentTableCol').fadeIn();
                    });
                }
            });

            if (isEditing) {
                $('#backButton').prop('disabled', true);
            } else {
                $('#backButton').prop('disabled', false);
            }
        };

        function editDetails(info) {
            isEditing = true;
            $('#detailsName').html(`<input type="text" class="form-control form-control-sm" id="editName" value="${info.name || ''}">`);
            $('#detailsID').html(`<input type="text" class="form-control form-control-sm" id="editID" value="${info.id || ''}">`);
            $('#detailsPhone').html(`<input type="text" class="form-control form-control-sm" id="editPhone" value="${info.phone || ''}">`);
            $('#detailsDate').html(`<input type="date" class="form-control form-control-sm" id="editDate" value="${info.date}">`);
            $('#detailsTime').html(`
                <select class="form-control form-control-sm" id="editTime" multiple>
                    <option value="06:00-07:00" ${info.timeSlots.includes('06:00-07:00') ? 'selected' : ''}>06:00-07:00</option>
                    <option value="07:00-08:00" ${info.timeSlots.includes('07:00-08:00') ? 'selected' : ''}>07:00-08:00</option>
                    <option value="08:00-09:00" ${info.timeSlots.includes('08:00-09:00') ? 'selected' : ''}>08:00-09:00</option>
                    <option value="09:00-10:00" ${info.timeSlots.includes('09:00-10:00') ? 'selected' : ''}>09:00-10:00</option>
                    <option value="10:00-11:00" ${info.timeSlots.includes('10:00-11:00') ? 'selected' : ''}>10:00-11:00</option>
                    <option value="11:00-12:00" ${info.timeSlots.includes('11:00-12:00') ? 'selected' : ''}>11:00-12:00</option>
                    <option value="12:00-13:00" ${info.timeSlots.includes('12:00-13:00') ? 'selected' : ''}>12:00-13:00</option>
                    <option value="13:00-14:00" ${info.timeSlots.includes('13:00-14:00') ? 'selected' : ''}>13:00-14:00</option>
                    <option value="14:00-15:00" ${info.timeSlots.includes('14:00-15:00') ? 'selected' : ''}>14:00-15:00</option>
                    <option value="15:00-16:00" ${info.timeSlots.includes('15:00-16:00') ? 'selected' : ''}>15:00-16:00</option>
                    <option value="16:00-17:00" ${info.timeSlots.includes('16:00-17:00') ? 'selected' : ''}>16:00-17:00</option>
                    <option value="17:00-18:00" ${info.timeSlots.includes('17:00-18:00') ? 'selected' : ''}>17:00-18:00</option>
                    <option value="18:00-19:00" ${info.timeSlots.includes('18:00-19:00') ? 'selected' : ''}>18:00-19:00</option>
                    <option value="19:00-20:00" ${info.timeSlots.includes('19:00-20:00') ? 'selected' : ''}>19:00-20:00</option>
                    <option value="20:00-21:00" ${info.timeSlots.includes('20:00-21:00') ? 'selected' : ''}>20:00-21:00</option>
                    <option value="21:00-22:00" ${info.timeSlots.includes('21:00-22:00') ? 'selected' : ''}>21:00-22:00</option>
                    <option value="22:00-23:00" ${info.timeSlots.includes('22:00-23:00') ? 'selected' : ''}>22:00-23:00</option>
                    <option value="23:00-24:00" ${info.timeSlots.includes('23:00-24:00') ? 'selected' : ''}>23:00-24:00</option>
                </select>
            `);
            $('#detailsReason').html(`<input type="text" class="form-control form-control-sm" id="editReason" value="${info.reason || ''}">`);
            $('#detailsStatus').html(`
                <select class="form-control form-control-sm" id="editStatus">
                    <option value="尚未繳費" ${info.status === '尚未繳費' ? 'selected' : ''}>尚未繳費</option>
                    <option value="預約成功" ${info.status === '預約成功' ? 'selected' : ''}>預約成功</option>
                    <option value="繳費逾期" ${info.status === '繳費逾期' ? 'selected' : ''}>繳費逾期</option>
                    <option value="已經取消" ${info.status === '已經取消' ? 'selected' : ''}>取消預約</option>
                </select>
            `);
            $('#detailsItem').html(`<input type="text" class="form-control form-control-sm" id="editItem" value="${info.item || ''}">`);
            $('#editButtonContainer').hide();
            $('#saveButtonContainer').show();

            $('#backButton').prop('disabled', true);

            loadRentInfo();  // Disable all view buttons

            $('#saveButton').off('click').on('click', function () {
                saveDetails();
            });
        }

        function saveDetails() {
            const rentInfoList = JSON.parse(localStorage.getItem(rentInfoKey)) || [];
            if (currentEditIndex !== null) {
                rentInfoList[currentEditIndex].name = $('#editName').val();
                rentInfoList[currentEditIndex].id = $('#editID').val();
                rentInfoList[currentEditIndex].phone = $('#editPhone').val();
                rentInfoList[currentEditIndex].date = $('#editDate').val();
                rentInfoList[currentEditIndex].timeSlots = $('#editTime').val();
                rentInfoList[currentEditIndex].reason = $('#editReason').val();
                rentInfoList[currentEditIndex].status = $('#editStatus').val();
                rentInfoList[currentEditIndex].item = $('#editItem').val();

                localStorage.setItem(rentInfoKey, JSON.stringify(rentInfoList));
                isEditing = false;
                loadRentInfo();
                viewDetails(currentEditIndex);
                $('#saveButtonContainer').hide();
                $('#editButtonContainer').show();
                $('#backButton').prop('disabled', false);
            }
        }

        loadRentInfo();
    });
</script>